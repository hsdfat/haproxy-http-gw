FROM golang:1.24-alpine AS builder

WORKDIR /src
COPY go.mod go.sum ./
RUN go mod download

COPY . .
RUN CGO_ENABLED=0 GOOS=linux go build -o /http-gateway ./cmd/http-gateway

FROM haproxytech/haproxy-alpine:3.2

RUN apk add --no-cache socat openssl ca-certificates

COPY --from=builder /http-gateway /usr/local/bin/http-gateway
RUN chmod +x /usr/local/bin/http-gateway

# Create directories
RUN mkdir -p /etc/haproxy/certs \
    /var/run \
    /tmp/haproxy-gateway \
    && chown -R haproxy:haproxy /etc/haproxy /var/run /tmp/haproxy-gateway

# Copy initial HAProxy config and entrypoint
COPY test/haproxy-init.cfg /etc/haproxy/haproxy.cfg
COPY test/scripts/gateway-entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh && chown haproxy:haproxy /entrypoint.sh /etc/haproxy/haproxy.cfg

USER haproxy
EXPOSE 8080 8443 9090

ENTRYPOINT ["/entrypoint.sh"]
